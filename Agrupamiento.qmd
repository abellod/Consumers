# Agrupamiento

Dados los objetivos de este proyecto, se caracteriza a los departamentos de acuerdo a su puntaje, estos son clasificados en 5 grupos pensando en que departamentos que pertenecen a la misma región geográfica pueden tener resultados similares en el puntaje global.

```{r}
#| echo: false
#| results: hide
#| message: false
#| warning: false

library(FactoClass)
library(Factoshiny)
library(factoextra)
library(plotly)
library(knitr)
library(DT)
library(GDAtools)
library(readr)
library(dplyr)

# 4 cifras significativas y sin notación científica:
options(digits = 4, scipen = 999) 

#setwd("C:\\Users\\soffy\\OneDrive\\Escritorio\\Universidad\\Multivariada\\Consumers")

# Carga de datos originales
saberpro <- read_delim("DATA_ICFES_SABERPROPROFESIONAL_2022-2.TXT", delim = "¬", escape_double = FALSE, trim_ws = TRUE)
kable(head(saberpro), digits=2) 

# nuestros datos
data <- saberpro[,-c(1,2,5:9,13:15,17:21,23:26,28:34,49:54,56:62,65,67:70,72:75,77:82,84:86,88:90,92:94,96:98,100:102,104:109)]

# genero
sum(is.na(data$ESTU_GENERO)) # hay 5 NA'S
data$ESTU_GENERO <- ifelse(is.na(data$ESTU_GENERO), "Desconocido", data$ESTU_GENERO)
data$ESTU_GENERO <- as.factor(data$ESTU_GENERO)
table(data$ESTU_GENERO)

# edad
# esta la quitamos
library(stringr)
edad <- str_sub(data$ESTU_FECHANACIMIENTO,7,10)
edad<-as.numeric(edad)
edades<-2023-edad
summary(edades)

# etnia
sum(is.na(data$ESTU_TIENEETNIA)) # 775 na's
data$ESTU_TIENEETNIA <- ifelse(is.na(data$ESTU_TIENEETNIA), "Desconocido", data$ESTU_TIENEETNIA)
data$ESTU_TIENEETNIA <- as.factor(data$ESTU_TIENEETNIA)
table(data$ESTU_TIENEETNIA)

# depto
data$ESTU_DEPTO_RESIDE<-ifelse(data$ESTU_DEPTO_RESIDE %in% c("BARCELONA","BUENOS AIRES","FRANKFURT","HOUSTON","LIMA","MIAMI","NUEVA YORK","PARIS","QUEBEC","ROMA","SACRAMENTO","SANTIAGO DE CHILE","SAO PAULO","SEUL","TRENTON"),"EXTRANJERO",data$ESTU_DEPTO_RESIDE)
sum(is.na(data$ESTU_DEPTO_RESIDE))
length(unique(data$ESTU_DEPTO_RESIDE)) # hay 35 pq son mas los extranjeros y NAs
data$ESTU_DEPTO_RESIDE <- ifelse(is.na(data$ESTU_DEPTO_RESIDE), "Desconocido", data$ESTU_DEPTO_RESIDE)
data$ESTU_DEPTO_RESIDE <- as.factor(data$ESTU_DEPTO_RESIDE)
#data <- data %>%
  # mutate(ESTU_DEPTO_RESIDE = case_when(
  #   ESTU_DEPTO_RESIDE == "BOGOTÁ" ~ ESTU_DEPTO_RESIDE,
  #   ESTU_DEPTO_RESIDE == "Desconocido" ~ "Desconocido",
  #   TRUE ~ "OTRO"
  # ))
data$ESTU_DEPTO_RESIDE <- as.factor(data$ESTU_DEPTO_RESIDE)
table(data$ESTU_DEPTO_RESIDE)


# estado civil
sum(is.na(data$ESTU_ESTADOCIVIL)) # 580 na's
data$ESTU_ESTADOCIVIL <- ifelse(is.na(data$ESTU_ESTADOCIVIL), "Desconocido", ifelse(data$ESTU_ESTADOCIVIL=="Casado","C",ifelse(data$ESTU_ESTADOCIVIL=="Separado y/o Viudo","SyoV",ifelse(data$ESTU_ESTADOCIVIL=="Soltero","S","UL"))))
data$ESTU_ESTADOCIVIL <- as.factor(data$ESTU_ESTADOCIVIL)
table(data$ESTU_ESTADOCIVIL)

# valor matricula
## recodificamos para que quede como factor
sum(is.na(data$ESTU_VALORMATRICULAUNIVERSIDAD)) # 2194 na's
data$ESTU_VALORMATRICULAUNIVERSIDAD <- ifelse(is.na(data$ESTU_VALORMATRICULAUNIVERSIDAD), "Desconocido", ifelse(data$ESTU_VALORMATRICULAUNIVERSIDAD=="Menos de 500 mil","m500",ifelse(data$ESTU_VALORMATRICULAUNIVERSIDAD=="Entre 500 mil y menos de 1 millón","e500m1",ifelse(data$ESTU_VALORMATRICULAUNIVERSIDAD=="Entre 1 millón y menos de 2.5 millones","e1m2.5",ifelse(data$ESTU_VALORMATRICULAUNIVERSIDAD=="Entre 2.5 millones y menos de 4 millones","e2.5m4",ifelse(data$ESTU_VALORMATRICULAUNIVERSIDAD=="Entre 4 millones y menos de 5.5 millones","e4m5.5",ifelse(data$ESTU_VALORMATRICULAUNIVERSIDAD=="Entre 5.5 millones y menos de 7 millones","e5.5m7",ifelse(data$ESTU_VALORMATRICULAUNIVERSIDAD=="Más de 7 millones","M7","NP"))))))))
data$ESTU_VALORMATRICULAUNIVERSIDAD <- factor(data$ESTU_VALORMATRICULAUNIVERSIDAD, levels = c("m500","e500m1", "e1m2.5", "e2.5m4","e4m5.5","e5.5m7","M7","NP","Desconocido"))
table(data$ESTU_VALORMATRICULAUNIVERSIDAD)

# capacitacion del examen
sum(is.na(data$ESTU_COMOCAPACITOEXAMENSB11)) # 2069 na's
data$ESTU_COMOCAPACITOEXAMENSB11 <- ifelse(is.na(data$ESTU_COMOCAPACITOEXAMENSB11), "Desconocido", ifelse(data$ESTU_COMOCAPACITOEXAMENSB11=="No realizó ninguna prueba de preparación","Ninguna",ifelse(data$ESTU_COMOCAPACITOEXAMENSB11=="Repasó por cuenta propia","CuentaPropia","Curso")))
data$ESTU_COMOCAPACITOEXAMENSB11 <- as.factor(data$ESTU_COMOCAPACITOEXAMENSB11)
table(data$ESTU_COMOCAPACITOEXAMENSB11)


# semestre que cursa
sum(is.na(data$ESTU_SEMESTRECURSA)) # 2194 na's
data$ESTU_SEMESTRECURSA<-ifelse(data$ESTU_SEMESTRECURSA %in% c("01","02","03","04","05","06"),"06m",ifelse(data$ESTU_SEMESTRECURSA=="12 o más","12M",data$ESTU_SEMESTRECURSA))
data$ESTU_SEMESTRECURSA <- ifelse(is.na(data$ESTU_SEMESTRECURSA), "Desconocido", data$ESTU_SEMESTRECURSA)
data$ESTU_SEMESTRECURSA <- as.factor(data$ESTU_SEMESTRECURSA)
table(data$ESTU_SEMESTRECURSA)

# educacion papa
sum(is.na(data$FAMI_EDUCACIONPADRE)) # 4738 na's
data$FAMI_EDUCACIONPADRE <- ifelse(is.na(data$FAMI_EDUCACIONPADRE), "Desconocido", ifelse(data$FAMI_EDUCACIONPADRE=="Educación profesional completa","EPC",ifelse(data$FAMI_EDUCACIONPADRE=="Educación profesional incompleta","EPI",ifelse(data$FAMI_EDUCACIONPADRE=="No Aplica","NAp",ifelse(data$FAMI_EDUCACIONPADRE=="No sabe","NS",ifelse(data$FAMI_EDUCACIONPADRE=="Postgrado","Post",ifelse(data$FAMI_EDUCACIONPADRE=="Primaria completa","PC",ifelse(data$FAMI_EDUCACIONPADRE=="Primaria incompleta","PI",ifelse(data$FAMI_EDUCACIONPADRE=="Secundaria (Bachillerato) completa","BC",ifelse(data$FAMI_EDUCACIONPADRE=="Secundaria (Bachillerato) incompleta","BI",ifelse(data$FAMI_EDUCACIONPADRE=="Técnica o tecnológica completa","TTC",ifelse(data$FAMI_EDUCACIONPADRE=="Técnica o tecnológica incompleta","TTI",data$FAMI_EDUCACIONPADRE))))))))))))
data$FAMI_EDUCACIONPADRE <- as.factor(data$FAMI_EDUCACIONPADRE)
table(data$FAMI_EDUCACIONPADRE)

# educacion mama
sum(is.na(data$FAMI_EDUCACIONMADRE)) # 4886 na's
data$FAMI_EDUCACIONMADRE <- ifelse(is.na(data$FAMI_EDUCACIONMADRE), "Desconocido", ifelse(data$FAMI_EDUCACIONMADRE=="Educación profesional completa","EPC",ifelse(data$FAMI_EDUCACIONMADRE=="Educación profesional incompleta","EPI",ifelse(data$FAMI_EDUCACIONMADRE=="No Aplica","NAp",ifelse(data$FAMI_EDUCACIONMADRE=="No sabe","NS",ifelse(data$FAMI_EDUCACIONMADRE=="Postgrado","Post",ifelse(data$FAMI_EDUCACIONMADRE=="Primaria completa","PC",ifelse(data$FAMI_EDUCACIONMADRE=="Primaria incompleta","PI",ifelse(data$FAMI_EDUCACIONMADRE=="Secundaria (Bachillerato) completa","BC",ifelse(data$FAMI_EDUCACIONMADRE=="Secundaria (Bachillerato) incompleta","BI",ifelse(data$FAMI_EDUCACIONMADRE=="Técnica o tecnológica completa","TTC",ifelse(data$FAMI_EDUCACIONMADRE=="Técnica o tecnológica incompleta","TTI",data$FAMI_EDUCACIONMADRE))))))))))))
data$FAMI_EDUCACIONMADRE <- as.factor(data$FAMI_EDUCACIONMADRE)
table(data$FAMI_EDUCACIONMADRE)

# ocupacion papa
sum(is.na(data$FAMI_OCUPACIONPADRE)) # 2060 na's
data$FAMI_OCUPACIONPADRE <- ifelse(is.na(data$FAMI_OCUPACIONPADRE), "Desconocido", ifelse(data$FAMI_OCUPACIONPADRE=="Empleado con cargo como director o gerente general","EDGG",ifelse(data$FAMI_OCUPACIONPADRE=="Empleado de nivel auxiliar o administrativo","ENAA",ifelse(data$FAMI_OCUPACIONPADRE=="Empleado de nivel directivo","END",ifelse(data$FAMI_OCUPACIONPADRE=="Empleado de nivel técnico o profesional","ENTP",ifelse(data$FAMI_OCUPACIONPADRE=="Empleado obrero u operario","EOO",ifelse(data$FAMI_OCUPACIONPADRE=="Empresario","Emp",ifelse(data$FAMI_OCUPACIONPADRE=="Hogar","H",ifelse(data$FAMI_OCUPACIONPADRE=="Otra actividad u ocupación","OAO", ifelse(data$FAMI_OCUPACIONPADRE=="Pensionado","Pen",ifelse(data$FAMI_OCUPACIONPADRE=="Pequeño empresario","PE",ifelse(data$FAMI_OCUPACIONPADRE=="Profesional independiente","PI","TCP"))))))))))))
data$FAMI_OCUPACIONPADRE <- as.factor(data$FAMI_OCUPACIONPADRE)
table(data$FAMI_OCUPACIONPADRE)

# ocupacion mama
sum(is.na(data$FAMI_OCUPACIONMADRE)) # 2060 na's
data$FAMI_OCUPACIONMADRE <- ifelse(is.na(data$FAMI_OCUPACIONMADRE), "Desconocido", ifelse(data$FAMI_OCUPACIONMADRE=="Empleado con cargo como director o gerente general","EDGG",ifelse(data$FAMI_OCUPACIONMADRE=="Empleado de nivel auxiliar o administrativo","ENAA",ifelse(data$FAMI_OCUPACIONMADRE=="Empleado de nivel directivo","END",ifelse(data$FAMI_OCUPACIONMADRE=="Empleado de nivel técnico o profesional","ENTP",ifelse(data$FAMI_OCUPACIONMADRE=="Empleado obrero u operario","EOO",ifelse(data$FAMI_OCUPACIONMADRE=="Empresario","Emp",ifelse(data$FAMI_OCUPACIONMADRE=="Hogar","H",ifelse(data$FAMI_OCUPACIONMADRE=="Otra actividad u ocupación","OAO", ifelse(data$FAMI_OCUPACIONMADRE=="Pensionado","Pen",ifelse(data$FAMI_OCUPACIONMADRE=="Pequeño empresario","PE",ifelse(data$FAMI_OCUPACIONMADRE=="Profesional Independiente","PI","TCP"))))))))))))
data$FAMI_OCUPACIONMADRE <- as.factor(data$FAMI_OCUPACIONMADRE)
table(data$FAMI_OCUPACIONMADRE)

# estrato
sum(is.na(data$FAMI_ESTRATOVIVIENDA)) # 5531 na's
data$FAMI_ESTRATOVIVIENDA <- ifelse(is.na(data$FAMI_ESTRATOVIVIENDA), "Desconocido", data$FAMI_ESTRATOVIVIENDA)
data$FAMI_ESTRATOVIVIENDA <- as.factor(data$FAMI_ESTRATOVIVIENDA)
table(data$FAMI_ESTRATOVIVIENDA)


# internet
sum(is.na(data$FAMI_TIENEINTERNET)) # 5697 na's
data$FAMI_TIENEINTERNET <- ifelse(is.na(data$FAMI_TIENEINTERNET), "Desconocido", data$FAMI_TIENEINTERNET)
data$FAMI_TIENEINTERNET <- as.factor(data$FAMI_TIENEINTERNET)
table(data$FAMI_TIENEINTERNET)

# computador
sum(is.na(data$FAMI_TIENECOMPUTADOR)) # 6163 na's
data$FAMI_TIENECOMPUTADOR <- ifelse(is.na(data$FAMI_TIENECOMPUTADOR), "Desconocido", data$FAMI_TIENECOMPUTADOR)
data$FAMI_TIENECOMPUTADOR <- as.factor(data$FAMI_TIENECOMPUTADOR)
table(data$FAMI_TIENECOMPUTADOR)

# lavadora
sum(is.na(data$FAMI_TIENELAVADORA)) # 6354 na's
data$FAMI_TIENELAVADORA <- ifelse(is.na(data$FAMI_TIENELAVADORA), "Desconocido", data$FAMI_TIENELAVADORA)
data$FAMI_TIENELAVADORA <- as.factor(data$FAMI_TIENELAVADORA)
table(data$FAMI_TIENELAVADORA)

# microogas
sum(is.na(data$FAMI_TIENEHORNOMICROOGAS)) # 7019 na's
data$FAMI_TIENEHORNOMICROOGAS <- ifelse(is.na(data$FAMI_TIENEHORNOMICROOGAS), "Desconocido", data$FAMI_TIENEHORNOMICROOGAS)
data$FAMI_TIENEHORNOMICROOGAS <- as.factor(data$FAMI_TIENEHORNOMICROOGAS)
table(data$FAMI_TIENEHORNOMICROOGAS)

# tv
sum(is.na(data$FAMI_TIENESERVICIOTV)) # 5801 na's
data$FAMI_TIENESERVICIOTV <- ifelse(is.na(data$FAMI_TIENESERVICIOTV), "Desconocido", data$FAMI_TIENESERVICIOTV)
data$FAMI_TIENESERVICIOTV <- as.factor(data$FAMI_TIENESERVICIOTV)
table(data$FAMI_TIENESERVICIOTV)

# auto
sum(is.na(data$FAMI_TIENEAUTOMOVIL)) # 7187 na's
data$FAMI_TIENEAUTOMOVIL <- ifelse(is.na(data$FAMI_TIENEAUTOMOVIL), "Desconocido", data$FAMI_TIENEAUTOMOVIL)
data$FAMI_TIENEAUTOMOVIL <- as.factor(data$FAMI_TIENEAUTOMOVIL)
table(data$FAMI_TIENEAUTOMOVIL)

# moto
sum(is.na(data$FAMI_TIENEMOTOCICLETA)) # 7525 na's
data$FAMI_TIENEMOTOCICLETA <- ifelse(is.na(data$FAMI_TIENEMOTOCICLETA), "Desconocido", data$FAMI_TIENEMOTOCICLETA)
data$FAMI_TIENEMOTOCICLETA <- as.factor(data$FAMI_TIENEMOTOCICLETA)
table(data$FAMI_TIENEMOTOCICLETA)

# consola
sum(is.na(data$FAMI_TIENECONSOLAVIDEOJUEGOS)) # 7993 na's
data$FAMI_TIENECONSOLAVIDEOJUEGOS <- ifelse(is.na(data$FAMI_TIENECONSOLAVIDEOJUEGOS), "Desconocido", data$FAMI_TIENECONSOLAVIDEOJUEGOS)
data$FAMI_TIENECONSOLAVIDEOJUEGOS <- as.factor(data$FAMI_TIENECONSOLAVIDEOJUEGOS)
table(data$FAMI_TIENECONSOLAVIDEOJUEGOS)

# horas trabaja
sum(is.na(data$ESTU_HORASSEMANATRABAJA)) # 6867 na's
data$ESTU_HORASSEMANATRABAJA <- ifelse(is.na(data$ESTU_HORASSEMANATRABAJA), "Desconocido", data$ESTU_HORASSEMANATRABAJA)
data$ESTU_HORASSEMANATRABAJA <- factor(data$ESTU_HORASSEMANATRABAJA, levels = c("0", "Menos de 10 horas", "Entre 11 y 20 horas", "Entre 21 y 30 horas", "Más de 30 horas", "Desconocido"))
table(data$ESTU_HORASSEMANATRABAJA)

# grupo de referencia
sum(is.na(data$GRUPOREFERENCIA)) # 0 na's
data$GRUPOREFERENCIA<-ifelse(data$GRUPOREFERENCIA=="ADMINISTRACIÓN Y AFINES","AdmYAfin",ifelse(data$GRUPOREFERENCIA=="ARQUITECTURA Y URBANISMO","ArqYUrb",ifelse(data$GRUPOREFERENCIA=="BELLAS ARTES Y DISEÑO","BelArtYDis",ifelse(data$GRUPOREFERENCIA=="CIENCIAS AGROPECUARIAS","CienAgr",ifelse(data$GRUPOREFERENCIA=="CIENCIAS MILITARES Y NAVALES","CienMilYNav",ifelse(data$GRUPOREFERENCIA=="CIENCIAS NATURALES Y EXACTAS","CienNatYExac",ifelse(data$GRUPOREFERENCIA=="CIENCIAS SOCIALES","CienSoc",ifelse(data$GRUPOREFERENCIA=="COMUNICACIÓN, PERIODISMO Y PUBLICIDAD","ComuPerYPub",ifelse(data$GRUPOREFERENCIA=="CONTADURÍA Y AFINES","ContYAfin",ifelse(data$GRUPOREFERENCIA=="DERECHO","Derecho",ifelse(data$GRUPOREFERENCIA=="ECONOMÍA","Economía",ifelse(data$GRUPOREFERENCIA=="ECONOMÍA, ADMINISTRACIÓN, CONTADURÍA Y AFINES - UNIVERSITARIA","EcAdContYAfinU",ifelse(data$GRUPOREFERENCIA=="EDUCACIÓN","Educación",ifelse(data$GRUPOREFERENCIA=="ENFERMERÍA","Enfermeria",ifelse(data$GRUPOREFERENCIA=="GRUPO REFERENCIA NACIONAL","GrupRefNal", ifelse(data$GRUPOREFERENCIA=="GRUPO REFERENCIA NACIONAL UNIVERSITARIO","GrupRefNalU", ifelse(data$GRUPOREFERENCIA=="HUMANIDADES","Hum", ifelse(data$GRUPOREFERENCIA=="INGENIERÍA","Inge", ifelse(data$GRUPOREFERENCIA=="MEDICINA","Med", ifelse(data$GRUPOREFERENCIA=="PSICOLOGÍA","Psic", ifelse(data$GRUPOREFERENCIA=="RECREACIÓN Y DEPORTES","RecYDep", "salud")))))))))))))))))))))
data$GRUPOREFERENCIA<- as.factor(data$GRUPOREFERENCIA)
table(data$GRUPOREFERENCIA)
str(data$GRUPOREFERENCIA) # 22 niveles

# metodo
sum(is.na(data$ESTU_METODO_PRGM)) # 0 na's
data$ESTU_METODO_PRGM <- ifelse(data$ESTU_METODO_PRGM == "DISTANCIA VITUAL", "distVirtual", ifelse(data$ESTU_METODO_PRGM=="DISTANCIA","distancia","presencial"))
data$ESTU_METODO_PRGM<- as.factor(data$ESTU_METODO_PRGM)
table(data$ESTU_METODO_PRGM)

# caracter academico institucion
sum(is.na(data$INST_CARACTER_ACADEMICO)) # 0 na's
data$INST_CARACTER_ACADEMICO<-ifelse(data$INST_CARACTER_ACADEMICO=="INSTITUCIÓN TECNOLÓGICA","InstTec",ifelse(data$INST_CARACTER_ACADEMICO=="INSTITUCIÓN UNIVERSITARIA","InstUni", ifelse(data$INST_CARACTER_ACADEMICO=="TÉCNICA PROFESIONAL","TecProf", "Universidad")))
data$INST_CARACTER_ACADEMICO<- as.factor(data$INST_CARACTER_ACADEMICO)
table(data$INST_CARACTER_ACADEMICO)

names(data)[29:33]<-c("cuanti","lec","ciu","ing","esc")
```

Para realizar la clasificación, se utiliza una estrategia completa de agrupamiento, donde se mezclan diferentes técnicas multivariadas. Inicialmente se realiza un *Análisis de Correspondecias Simples, ACS* entre las variables Departamento de residencia del estudiante (*ESTU_DEPTO_RESIDE*) y el puntaje global recodificado en 10 categorías utilizando los percentiles (*globalCAT*)

```{r}
#| echo: false
# # Recodificación puntaje global
# percentiles <- quantile(data$PUNT_GLOBAL, probs = c(0.2, 0.4, 0.6, 0.8))
# 
# data$globalCAT <- cut(data$PUNT_GLOBAL,
#                     breaks = c(-Inf, percentiles[1], percentiles[2], percentiles[3], percentiles[4], Inf),
#                     labels = c("Bajo", "Medio Bajo", "Medio", "Medio Alto", "Alto"))
# reco <- as.data.frame(table(data$globalCAT))
# colnames(reco)<-c("globalCAT","Frecuencia")
# kable(reco)

# Recodificación puntaje global
percentiles <- quantile(data$PUNT_GLOBAL, probs = c(0.1, 0.2, 0.3, 0.4, 0.5,  0.6, 0.7, 0.8, 0.9))

data$globalCAT <- cut(data$PUNT_GLOBAL,
                    breaks = c(0, percentiles[1], percentiles[2], percentiles[3], percentiles[4], percentiles[5], percentiles[6], percentiles[7], percentiles[8], percentiles[9], 300)#,
                    #labels = c("Bajo", "Medio Bajo", "Medio", "Medio Alto", "Alto")
                    )
reco <- as.data.frame(table(data$globalCAT))
colnames(reco)<-c("globalCAT","Frecuencia")
kable(reco)
```

## Procedimiento de agrupación

### Paso 1

Realización del ACS entre las variables *ESTU_DEPTO_RESIDE* y *gobalCAT*

```{r}
#| echo: false
#| message: false
# Para hacer el data frame que necesita dudi.coa para el acs
K <- unclass(table(data$ESTU_DEPTO_RESIDE, data$globalCAT))
K <- as.data.frame(K)
K <- K[rownames(K) != "EXTRANJERO", ] # Quitamos a los de extranjero


# ACS
set.seed(627) # es necesario fijar la semilla para fijar los valores iniciales del agrupamiento jerarquico
acs <- FactoClass(K, dudi.coa, # funcion acs
                  scanFC=FALSE, # para que no me pregunte en la consola cuantos ejes y cuantos clusters
                  nf=9, # numero de ejes que vamos a dejar
                  nfcl=9, # numero de ejes para usar en la clasificación
                  k.clust=5) # numero de clusters
```

```{r}
#| echo: false
# Inercia de los ejes
barplot(as.vector(acs$dudi$eig), col="darkblue")
```

### Paso 2

Si bien la mayor parte de la inercia se va para un solo eje, para el agrupamiento seleccionamos los 4 ejes ya que no son "demasiados" y pueden servir para clasificar mejor a los individuos (departamentos).

### Paso 3

No fue necesario realizar un K-means de pre-agrupamiento ya que solo se cuenta con 32 individuos (departamentos).

### Paso 4

Los indices de agrupación jerárquica de los departamentos utilizando el método de Wald se muestran a continuación.

```{r}
#| echo: false
barplot(rev(tail(acs$indices$Indice)), horiz=TRUE, col="darkblue")
```

### Paso 5

Como se mencionó previamente, el corte se hizo para 5 grupos, de modo que se obtienen los valores inciales para el K-means.

El dendograma de la agrupación jerárquica es:

```{r}
#| echo: false
sca <- dudi.coa(K, scannf=FALSE, nf=5)
F <- as.matrix(sca$li); n <- nrow(F)
set.seed(627)
hclCafe <- ward.cluster(dista=dist(F), h.clust=1) # función de FactoClass
plot(hclCafe, las=1, col="darkblue", main="", sub="", xlab="")
abline(h=seq(0, 7, 0.5), col="gray90", lty=3)
```

### Paso 6

A continuación, se muestran los cambios en tamaño y en la inercia luego del K-means

```{r}
#| echo: false
kable(acs$clus.summ[, 1:4])
```

En general, ni los tamaños de los grupos ni la inercia dentro-grupo se modificaron demasiado. El agrupamiento jerárquico dio una buena partición incial.

### Paso 7

Caracterización y visualización de los grupos:

::: panel-tabset
#### Grupo 1

En el grupo 1 se tiene:

-   Las categorías "$(113,124]$", "$(0,113]$" y "$(0124,132]$" están sobre-representadas, ya que sus $Test.Values$ son muy grandes en valor absoluto y positivos. El $48.2\%$ de los individuos en esta clase pertenecen a estas categorías, lo cual es **mucho más alto** que su proporción global del $31.1\%$.

-   Para las categorías "$(132,139]$" y "$(139,145]$", en proporción hay más en el grupo que en la proporción global, sin embargo, aunque sus $Test.Values$ son significativos, no son **tan altos** respecto a las categorías mencionadas anteriormente. Lo mismo pasa para la categoría "$(145,152]$" , sólo que para esta categoría la proporción del grupo es menor respecto a la proporción global, con un $Test.Value$ en valor absoluto mayor a dos pero que respecto a otras categorías no es tan notorio.

-   Por último, las categorías "$(152,160]$", "$(160,168]$", "$(168,180]$" y "$(180,300]$" están sub-representadas, ya que sus $Test.Values$ son muy grandes en valor absoluto y negativos. El $20.6\%$ de los individuos en esta clase pertenecen a estas categorías, lo cual es **más bajo** que su proporción global del $39.6\%$.

En general, este grupo contiene a personas que tuvieron un mal desempeño en el examen, sin embargo no es el peor, pues están más representados los individuos con puntajes en el intervalo "$(113,124]$" que en el intervalo "$(0,113]$".

```{r}
#| echo: false
repre <- acs$carac.frec
names(repre) <- c("cl1","cl2","cl3","cl4","cl5")

kable(repre$cl1)
```

Los departamentos que hacen parte del grupo 1 son:

```{r}
#| echo: false
cluster_df <- data.frame(
  Depto = names(acs$cluster),   # deptos
  Cluster = as.numeric(acs$cluster)  # clusters
)

#str(cluster_df)
kable(cluster_df[cluster_df$Cluster==1,])
```

Los mejores ejes para visualizar este grupo son 1 y 3 de acuerdo con `acs$cor.clus`

```{r}
#| echo: false
plotFactoClass(acs, x=1, y=3, cex.col=0.5,
               roweti="", infaxes="no", cstar=0)
```

#### Grupo 2

En el grupo 2 se tiene:

-   Las categorías "$(168,180]$" y "$(160,168]$" están sobre-representadas, ya que sus $Test.Values$ son muy grandes en valor absoluto y positivos, aunque en proporción, esto no se nota tanto, pues el $20.6\%$ de los individuos en esta clase pertenecen a estas categorías, lo cual es **más alto** que su proporción global del $19.1\%$, pero no es tan notorio.

-   Para las categorías "$(180,300]$" y "$(152,160]$", en proporción hay más en el grupo que en la proporción global, sin embargo, aunque sus $Test.Values$ son significativos, no son **tan altos** respecto a las categorías mencionadas anteriormente. Lo mismo pasa para las categorías "$(132,139]$" y "$(124,132]$", sólo que para estas categorías la proporción del grupo es menor respecto a la proporción global, con un $Test.Value$ en valor absoluto mayor a dos pero que respecto a otras categorías no es tan notorio.

-   Por último, las categorías "$(113,124]$" y "$(0,113]$" están sub-representadas, ya que sus $Test.Values$ son muy grandes en valor absoluto y negativos. El $19.3\%$ de los individuos en esta clase pertenecen a estas categorías, lo cual es **más bajo** que su proporción global del $20.9\%$, pero no es tan notorio.

En general, este grupo contiene a personas que tuvieron un buen desempeño en el examen, sin embargo no es el mejor, pues están más representados los individuos con puntajes en los intervalos "$(168,180]$" y "$(160,168]$" que en el intervalo "$(180,300]$".

```{r}
#| echo: false
kable(repre$cl2)
```

Los departamentos que hacen parte del grupo 2 son:

```{r}
#| echo: false

#str(cluster_df)
kable(cluster_df[cluster_df$Cluster==2,])
```

Los mejores ejes para visualizar este grupo son 1 y 3 de acuerdo con `acs$cor.clus`

```{r}
#| echo: false
plotFactoClass(acs, x=1, y=3, cex.col=0.5,
               roweti="", infaxes="no", cstar=0)
```

#### Grupo 3

En el grupo 3 se tiene:

-   Las categorías "$(180,300]$", "$(168,180]$" y "$(160,168]$" están sobre-representadas, ya que sus $Test.Values$ son muy grandes en valor absoluto y positivos, pues el $39.6\%$ de los individuos en esta clase pertenecen a estas categorías, lo cual es **más alto** que su proporción global del $28.9\%$.

-   Para la categoría "$(152,160]$", en proporción hay más en el grupo que en la proporción global, sin embargo, aunque su $Test.Value$ es significativo, no es **tan alto** respecto a las categorías mencionadas anteriormente. Lo mismo pasa para las categoría "$(139,145]$", sólo que para esta categoría la proporción del grupo es menor respecto a la proporción global, con un $Test.Value$ en valor absoluto mayor a dos pero que respecto a otras categorías no es tan notorio.-

-   Por último, las categorías "$(132,139]$", "$(124,132]$", "$(113,124]$" y "$(0,113]$" están sub-representadas, ya que sus $Test.Values$ son muy grandes en valor absoluto y negativos. El $30.9\%$ de los individuos en esta clase pertenecen a estas categorías, lo cual es **más bajo** que su proporción global del $41.3\%$.

En general, este grupo contiene a personas que tuvieron un desempeño excelente en el examen, indicado por el altísimo valor del $Test.Value$ de los individuos con puntajes en el intervalo "$(180,300]$", los mejores puntajes. Además, también se encuentra una mayor proporción de individuos con puntajes en los intervalos"$(168,180]$" y "$(160,168]$".

```{r}
#| echo: false
kable(repre$cl3)
```

Los departamentos que hacen parte del grupo 3 son:

```{r}
#| echo: false

#str(cluster_df)
kable(cluster_df[cluster_df$Cluster==3,])
```

Los mejores ejes para visualizar este grupo son 1 y 2 de acuerdo con `acs$cor.clus`

```{r}
#| echo: false
plotFactoClass(acs, x=1, y=2, cex.col=0.5,
               roweti="", infaxes="no", cstar=0)
```

#### Grupo 4

En el grupo 4 se tiene:

-   Las categorías "$(0,113]$", "$(113,124]$", "$(124,132]$" y "$(132,139]$" están sobre-representadas, ya que sus $Test.Values$ son muy grandes en valor absoluto y positivos, pues el $50\%$ de los individuos en esta clase pertenecen a estas categorías, lo cual es **más alto** que su proporción global del $41.3\%$.

-   Para las categorías "$(139,145]$" y "$(145,152]$", en proporción hay más en el grupo que en la proporción global, sin embargo, aunque sus $Test.Values$ son significativos, no son **tan altos** respecto a las categorías mencionadas anteriormente. Lo mismo pasa para la categoría "$(152,160]$", sólo que para esta categoría la proporción del grupo es menor respecto a la proporción global, con un $Test.Value$ en valor absoluto mayor a dos pero que respecto a otras categorías no es tan notorio.

-   Por último, las categorías "$(160,168]$", "$(168,180]$" y "$(180,300]$" están sub-representadas, ya que sus $Test.Values$ son muy grandes en valor absoluto y negativos. El $19.2\%$ de los individuos en esta clase pertenecen a estas categorías, lo cual es **más bajo** que su proporción global del $28.9\%$.

En general, este grupo contiene a personas que tuvieron un desempeño regular y malo en el examen, indicado por los altos valores del $Test.Value$ de los individuos con puntajes menores a 152.


```{r}
#| echo: false
kable(repre$cl4)
```

Los departamentos que hacen parte del grupo 4 son:

```{r}
#| echo: false

#str(cluster_df)
kable(cluster_df[cluster_df$Cluster==4,])
```

Los mejores ejes para visualizar este grupo son 1 y 2 de acuerdo con `acs$cor.clus`

```{r}
#| echo: false
plotFactoClass(acs, x=1, y=2, cex.col=0.5,
               roweti="", infaxes="no", cstar=0)
```

#### Grupo 5

En el grupo 5 se tiene:

-   Las categorías "$(0,113]$" y "$(113,124]$" están sobre-representadas, ya que sus $Test.Values$ son muy grandes en valor absoluto y positivos, pues el $64.6\%$ de los individuos en esta clase pertenecen a estas categorías, lo cual es **más alto** que su proporción global del $20.9\%$.

-   Para la categoría "$(124,132]$", en proporción hay más en el grupo que en la proporción global, sin embargo, aunque su $Test.Value$ es significativo, no es **tan altos** respecto a las categorías mencionadas anteriormente. Lo mismo pasa para las categorías "$(132,139]$" y "$(139,145]$", sólo que para esta categoría la proporción del grupo es menor respecto a la proporción global, con un $Test.Value$ en valor absoluto mayor a dos pero que respecto a otras categorías no es tan notorio.

-   Por último, las categorías "$(152,160]$", "$(160,168]$", "$(168,180]$" y "$(180,300]$" están sub-representadas, ya que sus $Test.Values$ son muy grandes en valor absoluto y negativos. El $8.1\%$ de los individuos en esta clase pertenecen a estas categorías, lo cual es **más bajo** que su proporción global del $49.8\%$.

En general, este grupo contiene a personas que tuvieron el peor desempeño del examen, indicado por el altísimo valor del $Test.Value$ de los individuos con puntajes en el intervalo "$(0,113]$", los peores puntajes. Resalta también lo subrepresentados que están los individuos con mejores puntajes en este grupo. Además, también se encuentra una mayor proporción de individuos con puntajes en el intervalo "$(113,124]$".

Les fue muy mal en el examen.

```{r}
#| echo: false
kable(repre$cl5)
```

Los departamentos que hacen parte del grupo 5 son:

```{r}
#| echo: false

#str(cluster_df)
kable(cluster_df[cluster_df$Cluster==5,])
```

Los mejores ejes para visualizar este grupo son 1 y 2 de acuerdo con `acs$cor.clus`

```{r}
#| echo: false
plotFactoClass(acs, x=1, y=2, cex.col=0.5,
               roweti="", infaxes="no", cstar=0)
```
:::

En términos generales, al ordenar los grupos de acuerdo a los puntajes, en orden descendente, quedan:

1.  Grupo 3: Les fue muy bien
2.  Grupo 2: Les fue bien
3.  Grupo 4: No les fue bien ... les fue regular y mal
4.  Grupo 1: Les fue mal
5.  Grupo 5: Les fue muy mal

## Mapa de Colombia

```{r}
#| echo: false
#| warning: false
cluster_df_map <- cluster_df
cluster_df_map <- cluster_df_map[cluster_df_map$Depto!="Desconocido",]
cluster_df_map$CodDep <- c("91","05", "81", "08", "11", "13", "15", "17", "18", "85", "19", "20", "27","23", "25", "94", "95", "41", "44", "47", "50", "52", "54", "86", "63", "66", "88", "68", "70", "73", "76", "97", "99")

library(sf)
#Aquí guardo área y poligonos para que R me logre graficar los departamentos
deptoshp <- st_read("MGN_DPTO_POLITICO.shp",quiet=TRUE)

#Usamos Left join para que haga el cruce por código de departamento y deje todas las columnas
#de deptoshp
mapdeptos <- deptoshp %>%
  left_join(cluster_df_map,by=c("DPTO_CCDGO"="CodDep")) %>%
  select(!(Depto))

#Ahora mundoshp es un mapa de todo el mundo y estamos filtrando los que limitan con locombia
mundoshp <- st_read("admin00.shp",quiet=TRUE)
mundocol <- mundoshp %>%
  filter(CNTRY_NAME %in% c("Peru","Brazil","Venezuela","Ecuador","Panama"))

#Box calcula el rectangulo que envuelve a todo el conjunto de media_pun_tabla mapdeptos (locombia)
#box deja un poquito a la izquierda porque tiene en cuenta a SAN ANDRES
box <- st_bbox(mapdeptos)
#box

mitema <- theme(legend.title=element_text(hjust = 0.5,color = "black"),
                legend.text=element_text(hjust = 0.5),
                plot.title=element_text(face="bold",size=15,vjust=0.5,hjust=0.5,color="black"),
                axis.title.x = element_text(hjust = 0.5, color = "black"),
                axis.title.y = element_text(hjust = 0.5, color = "black"))

# Gráfica
ggplot() +
  geom_sf(data=mundocol) +
  geom_sf(data=mapdeptos,aes(fill=as.factor(Cluster)),col="darkgray",linetype="solid") + #aes fill=xi, el color de relleno dependera de xi
  coord_sf(xlim=c(box$xmin,box$xmax),ylim=c(box$ymin,box$ymax),expand=FALSE) + #Aqui centramos el mapa en locombia
  labs(x="Longitud",y="Latitud",title="Colombia",fill="Grupos") + #Nombre Ejes
  scale_fill_manual(values = c("blue", "darkgreen", "red", "darkorange", "mediumorchid")) +
  annotate("text", x=c(-74.5,-68,-78,-69,-78.5), y=c(-2.5,0,-1,9,9), colour="black",
           label=c("Perú","Brasil","Ecuador","Venezuela","Panamá")) + #Coloco anotaciones en ciertas coordenadas
  theme(panel.background=element_rect(fill="lightblue")) + mitema
```

Vemos que aunque los grupos no son exactamente como las regiones geográficas, hay ciertas similitudes que vale resaltar. Las regiones periféricas como lo son la orinoquía o la amazonía, y algunos departamentos también costeros como la Guajira o Córdoba tienen puntajes parecidos, siendo estos bajos. Además, muchos departamentos más centrales pertenecientes a la región andina tienen puntajes también parecidos, siendo estos altos. En cuanto al resto tienen un desempeño regular salvando las dos excepciones más importantes, Chocó y Bogotá D.C., en donde se concentran los peores y los mejores puntajes respectivamente.

Aunque no sea una representación uno a uno de las regiones geográficas, se puede apreciar un patrón que vislumbra que las regiones periféricas por lo general tienen peores puntajes que las regiones más centrales.
